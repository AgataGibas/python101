

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.4. Czat (wersja podstawowa) &mdash; Python 101 0.5 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="copyright" title="Copyright" href="../../copyright.html"/>
    <link rel="top" title="Python 101 0.5 documentation" href="../../index.html"/>
        <link rel="up" title="4. Aplikacje internetowe" href="../index.html"/>
        <link rel="next" title="FAQ" href="../../faq/index.html"/>
        <link rel="prev" title="4.3. Quiz ORM" href="../quiz_orm/index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> Python 101</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../env.html">System i oprogramowanie</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../env.html#system-operacyjny">System operacyjny</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../env.html#windows-8-i-bios-uefi">Windows 8 i BIOS UEFI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../env.html#interpreter-pythona">Interpreter Pythona</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../env.html#edytory-ide-kodu">Edytory (IDE) kodu</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../env.html#materialy">Materiały</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../source_code.html">Przygotowanie katalogu projektu</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../source_code.html#pobieranie-materialow">Pobieranie materiałów</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../source_code.html#korzystanie-z-kodu-zrodlowego">Korzystanie z kodu źródłowego</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../source_code.html#synchronizacja-kodu">Synchronizacja kodu</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../podstawy/index.html">1. Podstawy Pythona</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/podstawy/index.html">1.1. Wprowadzenie do Pythona</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/przyklady/index.html">1.2. Python w przykładach</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/przyklady/index1.html">1.3. Warunki i pętle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/przyklady/index2.html">1.4. Listy, tuple i funkcje</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/przyklady/index3.html">1.5. Zbiory i słowniki</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/przyklady/index4.html">1.6. Znam Pythona?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/przyklady/index5.html">1.7. Nie znam Pythona... jeszcze</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../podstawy/index.html#materialy">1.8. Materiały</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../pygame/index.html">2. Gry w Pythonie</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/pong_str/index.html">2.1. Pong (str)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/pong/index.html">2.2. Pong (obj)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/tictactoe_str/index.html">2.3. Kółko i krzyżyk (str)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/tictactoe/index.html">2.4. Kółko i krzyżyk (obj)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/life_str/index.html">2.5. Życie Conwaya (str)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/life/index.html">2.6. Życie Conwaya (obj)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pygame/index.html#materialy">2.7. Materiały</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bazy/index.html">3. Bazy danych w Pythonie</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../bazy/sql/index.html">3.1. SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bazy/orm/index.html">3.2. Systemy ORM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bazy/index.html#materialy">3.3. Materiały</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">4. Aplikacje internetowe</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../quiz/index.html">4.1. Quiz</a></li>
<li class="toctree-l2"><a class="reference internal" href="../todo/index.html">4.2. ToDo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quiz_orm/index.html">4.3. Quiz ORM</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">4.4. Czat (wersja podstawowa)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#materialy">4.5. Materiały</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../git/git.html">Git - wersjonowanie kodów źródłowych</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#lokalne-repozytoria-z-historia-zmian">Lokalne repozytoria z historią zmian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#centrale-repozytoria-dostepne-przez-internet">Centrale repozytoria dostępne przez internet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#nowe-konto-github">Nowe konto GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#forkujemy-pierwszy-projekt">Forkujemy pierwszy projekt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#instalujemy-narzedzie-git">Instalujemy narzędzie GIT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#klonujemy-nasz-projekt-lokalnie">Klonujemy nasz projekt lokalnie</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#skok-do-wybranej-wersji-z-historii-zmian">Skok do wybranej wersji z historii zmian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#zmieniamy-i-zapisujemy-zmiany-w-lokalnym-repozytorium">Zmieniamy i zapisujemy zmiany w lokalnym repozytorium</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#wysylamy-zmiany-do-centralnego-repozytorium">Wysyłamy zmiany do centralnego repozytorium</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#przypisujemy-tagi-do-konkretnych-wersji-w-historii-zmian">Przypisujemy tagi do konkretnych wersji w historii zmian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#wysylamy-tagi-do-centralnego-repozytorium">Wysyłamy tagi do centralnego repozytorium</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../git/git.html#pobieramy-zmiany-z-centralnego-repozytorium">Pobieramy zmiany z centralnego repozytorium</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Python 101</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">4. Aplikacje internetowe</a> &raquo;</li>
      
    <li>4.4. Czat (wersja podstawowa)</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/webapps/czat/index.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="czat-wersja-podstawowa">
<h1>4.4. Czat (wersja podstawowa)<a class="headerlink" href="#czat-wersja-podstawowa" title="Permalink to this headline">¶</a></h1>
<p>Zastosowanie Pythona i frameworka Django do stworzenia aplikacji internetowej
Czat; prostego czata, w którym zarejestrowani użytkownicy będą mogli wymieniać się krótkimi wiadomościami.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#projekt-i-aplikacja" id="id13">Projekt i aplikacja</a></li>
<li><a class="reference internal" href="#model-widok-kontroler" id="id14">Model – Widok – Kontroler</a></li>
<li><a class="reference internal" href="#model-danych-i-baza" id="id15">Model danych i baza</a></li>
<li><a class="reference internal" href="#panel-administracyjny" id="id16">Panel administracyjny</a></li>
<li><a class="reference internal" href="#widoki-i-szablony" id="id17">Widoki i szablony</a></li>
<li><a class="reference internal" href="#rejestrowanie-uzytkownikow" id="id18">Rejestrowanie użytkowników</a></li>
<li><a class="reference internal" href="#logowanie-i-wylogowywanie" id="id19">Logowanie i wylogowywanie</a></li>
<li><a class="reference internal" href="#obsluga-wiadomosci" id="id20">Obsługa wiadomości</a></li>
<li><a class="reference internal" href="#materialy" id="id21">Materiały</a></li>
</ul>
</div>
<div class="section" id="projekt-i-aplikacja">
<h2><a class="toc-backref" href="#id13">4.4.1. Projekt i aplikacja</a><a class="headerlink" href="#projekt-i-aplikacja" title="Permalink to this headline">¶</a></h2>
<p>Tworzymy nowy projekt Django, a następnie uruchamiamy lokalny serwer,
który pozwoli śledzić postęp pracy. W katalogu domowym wydajemy polecenia w terminalu:</p>
<div class="code_no">Terminal nr <script>var ter_no = ter_no || 1; document.write(ter_no++);</script></div><div class="highlight-bash"><div class="highlight"><pre>~<span class="nv">$ </span>django-admin.py startproject czat
~<span class="nv">$ </span><span class="nb">cd </span>czat
~/czat<span class="nv">$ </span>python manage.py runserver
</pre></div>
</div>
<p>Powstanie katalog projektu <code class="file docutils literal"><span class="pre">czat</span></code> i podkatalog aplikacji o takiej samej nazwie <code class="file docutils literal"><span class="pre">chatter</span></code>.
Po wpisaniu w przeglądarce adresu <em>127.0.0.1:8000</em> zobaczymy stronę powitalną.</p>
<div class="figure">
<img alt="../../_images/czat01.png" src="../../_images/czat01.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Domyślnie serwer nasłuchuje na porcie <code class="docutils literal"><span class="pre">8000</span></code>, można go jednak uruchomić
na innyn, jeżeli domyślny byłby zajęty. Wystarczy, że do polecenia dodamy
np.: <code class="docutils literal"><span class="pre">127.0.0.1:8080</span></code>.</p>
<p>W systemach Linux możemy kliknąć w terminalu prawym klawiszem adres <code class="docutils literal"><span class="pre">http://127.0.0.1:8000/</span></code>
i wybrać polecenie &#8220;Otwórz link&#8221;, aby szybko otworzyć domyślną przeglądarkę.
Lokalny serwer deweloperski zatrzymujemy za pomocą skrótu <code class="kbd docutils literal"><span class="pre">Ctrl+C</span></code>.</p>
<p class="last">Jeden projekt może zawierać wiele aplikacji zapisywanych w osobnych podkatalogach katalogu projektu.</p>
</div>
<p>Rozpoczynamy od modyfikacji ustawień projektu, tak aby korzystał z polskiej wersji językowej
oraz lokalnych ustawień daty i czasu. Musimy również zarejestrować naszą aplikację w projekcie.
W pliku <code class="file docutils literal"><span class="pre">setting.py</span></code> zmieniamy następujące linie:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><div class="highlight"><pre><span class="c"># czat/czat/settings.py</span>

<span class="c"># rejestrujemy aplikacje</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s">&#39;czat&#39;</span><span class="p">,</span> <span class="c"># rejestrujemy aplikację</span>
<span class="p">)</span>

<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">&#39;pl&#39;</span> <span class="c"># ustawienie języka</span>

<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">&#39;Europe/Warsaw&#39;</span> <span class="c"># ustawienie strefy czasowej</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Uwaga: jeżeli w plikach Pythona chcemy stosować polskie znaki, m.in.
w komentarzach, na początku każdego pliku powinna znaleźć się linia
definiująca kodowanie: <code class="docutils literal"><span class="pre">#</span> <span class="pre">-*-</span> <span class="pre">coding:</span> <span class="pre">utf-8</span> <span class="pre">-*-</span></code>.</p>
</div>
</div>
<div class="section" id="model-widok-kontroler">
<h2><a class="toc-backref" href="#id14">4.4.2. Model – Widok – Kontroler</a><a class="headerlink" href="#model-widok-kontroler" title="Permalink to this headline">¶</a></h2>
<p>W projektowaniu aplikacji internetowych za pomocą Django odwołujemy się do wzorca M(odel)V(iew)C(ontroller),
czyli Model–Widok–Kontroler <a class="footnote-reference" href="#id3" id="id1">[1]</a>, co pozwala na oddzielenie danych od ich prezentacji oraz logiki aplikacji.
Funkcje kolejnych elementów są następujące:</p>
<ul class="simple">
<li>Modele – <a class="reference internal" href="../todo/index.html#term-model"><span class="xref std std-term">model</span></a> w Django reprezentuje źródło informacji;
są to klasy Pythona odwzorowujące pojedyncze tabele w bazie danych <a class="footnote-reference" href="#id4" id="id2">[2]</a>;
każda klasa zawiera właściwości odpowiadające polom tabeli,
może też zawierać funkcje wykonujące operacje na danych.
Instancja takiej klasy odpowiada rekordowi danych.
Modele definiujemy w pliku <code class="file docutils literal"><span class="pre">models.py</span></code>.</li>
<li>Widoki – <a class="reference internal" href="../todo/index.html#term-widok"><span class="xref std std-term">widok</span></a> w Django to funkcja czy klasa Pythona, która na podstawie żądań www
(dla danych adresów URL) zwraca odpowiedź, najczęściej w postaci kodu HTML
generowanego w szablonach (templates); odpowiedzią może być również
przekierowanie na inny adres, jakiś dokument lub obrazek.
Django zawiera wiele widoków wbudowanych. Widoki modyfikujemy
lub definiujemy w pliku <code class="file docutils literal"><span class="pre">views.py</span></code>.</li>
<li>Kontroler – <a class="reference internal" href="../todo/index.html#term-kontroler"><span class="xref std std-term">kontroler</span></a> to mechanizm kierujący kolejne żądania
do odpowiednich widoków na podstawie wzorców adresów URL zawartych w pliku <code class="file docutils literal"><span class="pre">urls.py</span></code>.</li>
</ul>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Twórcy Django traktują jednak ten wzorzec elastycznie, mówiąc że ich
framework wykorzystuje wzorzec MTV, czyli model (model), szablon (template), widok (view).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Takie odwzorowanie nosi nazwę mapowania obiektowo-relacyjnego (ORM).
ORM odwzorowuje strukturę bazy na obiekty Pythona.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="model-danych-i-baza">
<h2><a class="toc-backref" href="#id15">4.4.3. Model danych i baza</a><a class="headerlink" href="#model-danych-i-baza" title="Permalink to this headline">¶</a></h2>
<p>Pisanie aplikacji zaczynamy od zdefiniowania modelu, czyli klasy opisującej
tabelę zawierającą wiadomości. Instancje tej klasy będą konkretnymi wiadomościami
utworzonymi przez użytkowników systemu.
Każda wiadomość będzie zwierała treść, datę dodania oraz autora wiadomości (użytkownika).</p>
<p>W pliku <code class="file docutils literal"><span class="pre">~/czat/czat/models.py</span></code>, który musimy utworzyć, wpisujemy:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># czat/czat/models.py</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">Wiadomosc</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Klasa reprezentująca wiadomość w systemie&quot;&quot;&quot;</span>
    <span class="n">tekst</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="n">data_pub</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">autor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Jak widać, podczas opisywania klasy <code class="docutils literal"><span class="pre">Wiadomosc</span></code> podajemy nazwy poszczególnych
właściwości (pól) oraz typy przechowywanych w nich danych.
Po zdefiniowaniu przynajmniej jednego modelu możemy utworzyć bazę danych
dla naszej aplikacji, czyli wszystkie potrzebne tabele.
Podczas tworzenia bazy Django pyta o nazwę, email i hasło administratora.
Podajemy te dane po wydaniu w katalogu projektu w terminalu polecenia:</p>
<div class="code_no">Terminal nr <script>var ter_no = ter_no || 1; document.write(ter_no++);</script></div><div class="highlight-bash"><div class="highlight"><pre>~/czat <span class="nv">$ </span>python manage.py syncdb
</pre></div>
</div>
<div class="figure">
<img alt="../../_images/czat02ter.png" src="../../_images/czat02ter.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Domyślnie Django korzysta z bazy SQLite, która przechowywana jest w jednym pliku <code class="file docutils literal"><span class="pre">db.sqlite3</span></code> w katalogu aplikacji.
Warto zobaczyć, jak wygląda. Potrzebny będzie jednak interpreter, który w razie
potrzeby doinstalujemy poleceniem <code class="docutils literal"><span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">sqlite3</span></code>. Następnie
W terminalu wydajemy polecenie <code class="docutils literal"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">dbshell</span></code>,
które uruchamia interpreter bazy. Następnie możemy wylistować utworzone tabele
poleceniem <code class="docutils literal"><span class="pre">.tables</span></code>. Możemy również zobaczyć jakie instrukcje SQL-a
zostały użyte do utworzenia naszej tabeli: <code class="docutils literal"><span class="pre">.schema</span> <span class="pre">czat_wiadomosc</span></code>.
Z interpretera wychodzimy poleceniem <code class="docutils literal"><span class="pre">.quit</span></code>.</p>
</div>
<div class="figure">
<img alt="../../_images/czat03ter.png" src="../../_images/czat03ter.png" />
</div>
</div>
<div class="section" id="panel-administracyjny">
<h2><a class="toc-backref" href="#id16">4.4.4. Panel administracyjny</a><a class="headerlink" href="#panel-administracyjny" title="Permalink to this headline">¶</a></h2>
<p>Django pozwala szybko utworzyć panel administratora dla projektu, dzięki czemu będziemy mogli zacząć
dodawać użytkowików i wprowadzać dane. Tworzymy więc plik <code class="file docutils literal"><span class="pre">~/czat/czat/admin.py</span></code>
i rejestrujemy w nim nasz model jako element panelu administracyjnego:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># czat/czat/admin.py</span>

<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">czat.models</span> <span class="kn">import</span> <span class="n">Wiadomosc</span> <span class="c"># importujemy nasz model</span>

<span class="c"># rejestrujemy model Wiadomosc w panelu administracyjnym</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Wiadomosc</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Jeżeli korzystamy z Django w wersji 1.6 przed skorzystaniem z panelu administratora
jako superużytkownik, musimy dodać linię: <code class="docutils literal"><span class="pre">admin.autodiscover()</span></code> w pliku
<code class="file docutils literal"><span class="pre">urls.py</span></code> przed deklaracją zmiennej <code class="docutils literal"><span class="pre">urlpatterns</span></code>. (Zobacz kod nr 7
poniżej.)</p>
</div>
<p>Po ewentualnym ponownym uruchomieniu serwera wchodzimy na adres <em>127.0.0.1:8080/admin/</em>.
Logujemy się podając dane wprowadzone podczas tworzenia bazy.
Otrzymamy dostęp do panelu administracyjnego, w którym możemy dodawać nowych użytkowników i wiadomości <a class="footnote-reference" href="#id6" id="id5">[3]</a>.</p>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td>Bezpieczna aplikacja powinna dysponować osobnym mechanizmem rejestracji
użytkowników i dodawania wiadomości, tak by nie trzeba było udostępniać
panelu administracyjnego osobom postronnym.</td></tr>
</tbody>
</table>
<div class="figure">
<img alt="../../_images/czat04adm.png" src="../../_images/czat04adm.png" />
</div>
<div class="figure">
<img alt="../../_images/czat05adm.png" src="../../_images/czat05adm.png" />
</div>
<p>W panelu administratora widać, że etykiety oznaczające pojedynczą wiadomość
jak i wiele wiadomości nie są spolszczone, podobnie pole daty oznaczone
jest etykietą &#8220;Data pub&#8221;. Aby w pełni spolszczyć nasz model, w pliku <code class="file docutils literal"><span class="pre">models.py</span></code>
dopisujemy:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># czat/czat/models.py</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">Wiadomosc</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Klasa reprezentująca wiadomość w systemie&quot;&quot;&quot;</span>
    <span class="n">tekst</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s">u&#39;wiadomość&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
    <span class="n">data_pub</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s">u&#39;data publikacji&#39;</span><span class="p">)</span>
    <span class="n">autor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span> <span class="c"># ustawienia dodatkowe</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s">u&#39;wiadomość&#39;</span> <span class="c"># nazwa obiektu w języku polskim</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s">u&#39;wiadomości&#39;</span> <span class="c">#  nazwa obiektów w l.m.</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;data_pub&#39;</span><span class="p">]</span> <span class="c"># domyślne porządkowanie danych</span>
</pre></div>
</td></tr></table></div>
<p>Jak widać, w definicjach każdego pola jako pierwszy argument możemy dopisać
spolszczoną etykietę, np. <code class="docutils literal"><span class="pre">u'data</span> <span class="pre">publikacji'</span></code>. W podklasie <code class="docutils literal"><span class="pre">Meta</span></code> podajemy natomiast
nazwy modelu w liczbie pojedynczej i mnogiej. Po odświeżeniu panelu
adminitracyjnego (np. klawiszem <code class="kbd docutils literal"><span class="pre">F5</span></code>) nazwy zostaną spolszczone.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Prefix <code class="docutils literal"><span class="pre">u</span></code> przed łańcuchami znaków oznacza kodowanie unikod (ang. <em>unicode</em>)
umożliwiające wyświetlanie m.in. znaków narodowych.</p>
</div>
<div class="section" id="cwiczenie-1">
<h3>4.4.4.1. Ćwiczenie 1<a class="headerlink" href="#cwiczenie-1" title="Permalink to this headline">¶</a></h3>
<p>Po zalogowaniu na konto administratora dodajemy użytkownika &#8220;adam&#8221;.
Na stronie szczegółów, która wyświetli się po jego utworzeniu, zaznaczamy
opcję &#8220;W zespole&#8221;, następnie w panelu &#8220;Dostępne uprawnienia&#8221; zaznaczmy opcje
dodawania (add), zmieniania (change) oraz usuwania (del) wiadomości
(wpisy typu: &#8220;czat | wiadomosc | Can add wiadomosc&#8221;) i przypisujemy je
użytkownikowi naciskając strzałkę w prawo.</p>
<div class="figure">
<img alt="../../_images/czat06adm.png" src="../../_images/czat06adm.png" />
</div>
<p>Przelogowujemy się na konto &#8220;adam&#8221; i dodajemy kilka przykładowych wiadomości.</p>
<div class="figure">
<img alt="../../_images/czat08adm.png" src="../../_images/czat08adm.png" />
</div>
<p>Jak można zauważyć, dodane wiadomości wyświetlają się na liście jako &#8220;Wiadomosc object&#8221;.
Aby to poprawić, uzupełniamy definicję naszego modelu o funkcję,
której zadaniem jest &#8220;autoprezentacja&#8221;, czyli wyświetlenie treści wiadomości.
W pliku <code class="file docutils literal"><span class="pre">models.py</span></code> dopisujemy zachowując wcięcia (!):</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19</pre></div></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tekst</span> <span class="c"># &quot;autoprezentacja&quot;</span>
</pre></div>
</td></tr></table></div>
<div class="figure">
<img alt="../../_images/czat09adm.png" src="../../_images/czat09adm.png" />
</div>
</div>
</div>
<div class="section" id="widoki-i-szablony">
<h2><a class="toc-backref" href="#id17">4.4.5. Widoki i szablony</a><a class="headerlink" href="#widoki-i-szablony" title="Permalink to this headline">¶</a></h2>
<p>Panel administracyjny już mamy, ale po wejściu na stronę główną zwykły użytkownik
niczego ciekawego poza standardowym powitaniem Django nie widzi. Zajmiemy się teraz
stronami po stronie (:-)) użytkownika.</p>
<p>Dodawanie stron w Django polega na wykorzystywaniu widoków wbudowanych lub
tworzeniu nowych. Są to klasy lub funkcje Pythona wykonujące jakieś operacje
po stronie serwera w odpowiedzi na żądania klienta. Widoki powiązane są
z określonymi adresami url. Widoki najczęściej zwracają kod HTML
wyrenderowany na podstawie szablonów, do których możemy przekazywać dodatkowe dane <a class="footnote-reference" href="#id8" id="id7">[4]</a>,
np. z bazy. Dla przejrzystości przyjęto, że w katalogu aplikacji (<code class="file docutils literal"><span class="pre">czat/czat</span></code>):</p>
<ol class="arabic simple">
<li>plik <code class="file docutils literal"><span class="pre">views.py</span></code> zawiera definicję widoków, w tym wywołania szablonów,</li>
<li>plik <code class="file docutils literal"><span class="pre">url.py</span></code> zawiera reguły łączące adresy url z widokami,</li>
<li>w katalogu <code class="file docutils literal"><span class="pre">czat/czat/templates/czat</span></code> zapisujemy szablony pod nazwami
określonymi w wywołujących je widokach, np. <code class="file docutils literal"><span class="pre">index.html</span></code>.</li>
</ol>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[4]</a></td><td>Dane z bazy przekazywane są do szablonów za pomocą Pythonowego słownika.
Renderowanie polega na odszukaniu pliku szablonu, zastąpieniu przekazanych
zmiennych danymi i odesłaniu całości (HTML + dane) do użytkownika.</td></tr>
</tbody>
</table>
<p>Aby utworzyć stronę główną, stworzymy pierwszy widok, czyli funkcję <code class="docutils literal"><span class="pre">index()</span></code> <a class="footnote-reference" href="#id10" id="id9">[5]</a>,
którą powiążemy z adresem URL głównej strony (/). Najprostszy widok zwraca
podany tekst. W pliku <code class="file docutils literal"><span class="pre">views.py</span></code> umieszczamy:</p>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[5]</a></td><td>Nazwa <code class="docutils literal"><span class="pre">index()</span></code> jest przykładowa, funkcja mogłaby się nazywać inaczej.</td></tr>
</tbody>
</table>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># czat/czat/views.py</span>

<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Strona główna aplikacji.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Witaj w aplikacji Czat!&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Warto zapamiętać, że każdą funkcję, formularz czy widok udostępniane
przez Django, których chcemy użyć, musimy najpierw zaimportować za pomocą
klauzuli typu <code class="docutils literal"><span class="pre">from</span> <span class="pre">&lt;skąd&gt;</span> <span class="pre">import</span> <span class="pre">&lt;co&gt;</span></code>.</p>
</div>
<p>W pliku <code class="file docutils literal"><span class="pre">urls.py</span></code> przede wszystkim importujemy widoki naszej aplikacji:
<code class="docutils literal"><span class="pre">from</span> <span class="pre">czat</span> <span class="pre">import</span> <span class="pre">views</span></code>. Następnie widok <cite>index()</cite> łączymy z adresem
URL strony głównej (/):</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># czat/czat/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="hll"><span class="kn">from</span> <span class="nn">czat</span> <span class="kn">import</span> <span class="n">views</span> <span class="c"># importujemy zdefiniowane w pliku views.py widoki</span>
</span>
<span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span> <span class="c"># potrzebne tylko w Django 1.6</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
<span class="hll">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Podstawową funkcją jest tu <code class="docutils literal"><span class="pre">url()</span></code>, która jako pierwszy parametr przyjmuje wyrażenie
regularne oznaczane skrótem <code class="docutils literal"><span class="pre">r</span></code> przed łańcuchem. Symbol <code class="docutils literal"><span class="pre">^</span></code> oznacza początek
łańcucha, <code class="docutils literal"><span class="pre">$</span></code> – koniec. Zapis <code class="docutils literal"><span class="pre">u'^$'</span></code> to adres główny serwera.
Drugi parametr wskazuje widok (funkcję), która ma obsłużyć dany adres.
Trzeci parametr <code class="docutils literal"><span class="pre">name</span></code> pozwala zapamiętać skojarzenie url-a i widoku pod nazwą,
której będzie można użyć np. do wygenerowania adresu linku.</p>
<p>Skoro mamy widok i przypisaliśmy go do jakiegoś adresu URL, możemy przetestować
działanie aplikacji. Po wywołaniu strony głównej powinniśmy zobaczyć tekst
podany jako argument funkcji <code class="docutils literal"><span class="pre">HttpResponse()</span></code> w pliku <code class="file docutils literal"><span class="pre">views.py</span></code>:</p>
<div class="figure">
<img alt="../../_images/czat10.png" src="../../_images/czat10.png" />
</div>
<p>Zazwyczaj odpowiedzią na wywołanie jakiegoś adresu URL będzie jednak jakaś
strona zapisana w języku HTML. Szablony takich stron umieszczamy w podkatalogu
<code class="docutils literal"><span class="pre">templates/nazwa</span> <span class="pre">aplikacji</span></code>. Tworzymy więc katalog:</p>
<div class="code_no">Terminal nr <script>var ter_no = ter_no || 1; document.write(ter_no++);</script></div><div class="highlight-bash"><div class="highlight"><pre>~/czat/czat<span class="nv">$ </span>mkdir -p templates/czat
</pre></div>
</div>
<p>Następnie tworzymy szablon, czyli plik <code class="file docutils literal"><span class="pre">~/czat/czat/templates/czat/index.html</span></code>, który zawiera:</p>
<div class="code_no">Plik index.html nr <script>var plik_no = plik_no || 1; document.write(plik_no++);</script></div><div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">&lt;!-- czat/czat/templates/czat/index.html --&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Witaj w aplikacji Czat!<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>W pliku <code class="file docutils literal"><span class="pre">views.py</span></code> zmieniamy instrukcje odpowiedzi:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="c"># czat/czat/views.py</span>

<span class="c">#from django.http import HttpResponse</span>
<span class="hll"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Strona główna aplikacji.&quot;&quot;&quot;</span>
<span class="hll">    <span class="c">#return HttpResponse(&quot;Witaj w aplikacji Czat!&quot;)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;czat/index.html&#39;</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>Po zaimportowaniu funkcji <code class="docutils literal"><span class="pre">render()</span></code> używamy jej do zwrócenia szablonu.
Jako pierwszy argument podajemy parametr <code class="docutils literal"><span class="pre">request</span></code>, a jako drugi nazwę
szablonu uwzględniającą katalog nadrzędny.</p>
<p>Po wpisaniu adresu <em>127.0.0.1:8000/</em> zobaczymy tekst, który umieściliśmy w szablonie:</p>
<div class="figure">
<img alt="../../_images/czat11.png" src="../../_images/czat11.png" />
</div>
</div>
<div class="section" id="rejestrowanie-uzytkownikow">
<h2><a class="toc-backref" href="#id18">4.4.6. Rejestrowanie użytkowników</a><a class="headerlink" href="#rejestrowanie-uzytkownikow" title="Permalink to this headline">¶</a></h2>
<p>Zamiast zakładać konta użytkownikom w panelu administracyjnym udostępnimy
im możliwość samodzielnego rejestrowania. Zadanie to można zrealizować na
dwa sposoby. Pierwszy polega na &#8220;ręcznym&#8221; utworzeniu formularza i obsłużeniu
przesłanych danych w skojarzonym widoku (funkcji).
Przygotujemy więc widok <code class="docutils literal"><span class="pre">rejestruj()</span></code>, który:</p>
<ol class="arabic simple">
<li>zwróci formularz przygotowany w szablonie <code class="file docutils literal"><span class="pre">rejestruj.html</span></code> w odpowiedzi
na żądanie typu <a class="reference internal" href="../todo/index.html#term-get"><span class="xref std std-term">GET</span></a>, wysłane przez przeglądarkę po wejściu
użytkownika na stronę rejestracji pod adres URL <em>/rejestruj</em>;</li>
<li>obsłuży żądanie typu <a class="reference internal" href="../todo/index.html#term-post"><span class="xref std std-term">POST</span></a>, czyli wysłanie danych z formularza na serwer,
sprawdzi poprawność przesłanych danych (nazwę użytkownika i hasło) i
utworzy konto;</li>
<li>zaloguje nowego użytkownika i przekieruje go na stronę główną.</li>
</ol>
<p>Zaczynamy od uzupełnienia pliku <code class="file docutils literal"><span class="pre">views.py</span></code>. Dodajemy widok <code class="docutils literal"><span class="pre">rejestruj()</span></code>:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Strona główna aplikacji.&quot;&quot;&quot;</span>
    <span class="c">#return HttpResponse(&quot;Witaj w aplikacji Czat!&quot;)</span>
    <span class="n">kontekst</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;czat/index.html&#39;</span><span class="p">,</span> <span class="n">kontekst</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth</span> <span class="kn">import</span> <span class="n">authenticate</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">logout</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>

<span class="k">def</span> <span class="nf">rejestruj</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rejestracja nowego użytkownika.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">UserCreationForm</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;Zostałeś zarejestrowany.&quot;</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">authenticate</span><span class="p">(</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;password1&#39;</span><span class="p">])</span>
            <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;Zostałeś zalogowany.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

    <span class="n">kontekst</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">UserCreationForm</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;czat/rejestruj.html&#39;</span><span class="p">,</span> <span class="n">kontekst</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Powyższy kod pokazuje m .in., w jaki sposób przekazać dowolne dane do szablonu.
Używamy słownika, w naszym przypadku nazwanego <code class="docutils literal"><span class="pre">kontekst</span></code>, który zostaje
użyty jako trzeci argument funkcji <code class="docutils literal"><span class="pre">render()</span></code>. W ten sposób przekazujemy
obiekt użytkownika w widoku strony głównej i formularz w widoku rejestracji.</p>
<p>Warto także zauważyć, jak tworzymy komunikaty zwrotne dla użytkownika.
Wykorzystujemy wbudowany w Django system komunikatów: <code class="docutils literal"><span class="pre">messages.success(request,</span> <span class="pre">&quot;Zostałeś</span> <span class="pre">zarejestrowany.&quot;)</span></code>.
Tak utworzone komunikaty możemy odczytać w każdym szablonie ze zmiennej
<code class="docutils literal"><span class="pre">messages</span></code> (zob. niżej szablon <code class="file docutils literal"><span class="pre">index.html</span></code>).</p>
<p>Tworzymy nowy szablon <code class="file docutils literal"><span class="pre">~/czat/czat/templates/czat/rejestruj.html</span></code>:</p>
<div class="code_no">Plik rejestruj.html nr <script>var plik_no = plik_no || 1; document.write(plik_no++);</script></div><div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">&lt;!-- czat/czat/templates/czat/rejestruj.html --&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Rejestracja użytkownika<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
            {% csrf_token %}
            {{ form.as_p }}
            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Zarejestruj<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Wiążemy adres URL <em>rejestruj/</em> z utworzonym widokiem. Do pliku <code class="file docutils literal"><span class="pre">urls.py</span></code>
dopisujemy:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
<span class="hll">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^rejestruj/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">rejestruj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;rejestruj&#39;</span><span class="p">),</span>
</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Gdybyśmy już teraz odwiedzili adres <code class="docutils literal"><span class="pre">127.0.0.1:8000/rejestruj</span></code>, powinniśmy
zobaczyć poniższy formularz:</p>
<div class="figure">
<img alt="../../_images/czat12rej.png" src="../../_images/czat12rej.png" />
</div>
<p>Modyfikujemy również szablon strony głównej:</p>
<div class="code_no">Plik index.html nr <script>var plik_no = plik_no || 1; document.write(plik_no++);</script></div><div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">&lt;!-- czat/czat/templates/czat/index.html --&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Witaj w aplikacji Czat!<span class="nt">&lt;/h1&gt;</span>

        {% if messages %}
            <span class="nt">&lt;ul&gt;</span>
            {% for komunikat in messages %}
                <span class="nt">&lt;li&gt;</span>{{ komunikat|capfirst }}<span class="nt">&lt;/li&gt;</span>
            {% endfor %}
            <span class="nt">&lt;/ul&gt;</span>
        {% endif %}
      
        {% if user.is_authenticated %}
            <span class="nt">&lt;p&gt;</span>Jesteś zalogowany jako {{ user.username }}.<span class="nt">&lt;/p&gt;</span>
        {% else %}
            <span class="nt">&lt;p&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;{% url &#39;rejestruj&#39; %}&quot;</span><span class="nt">&gt;</span>Zarejestruj się<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        {% endif %}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>W szablonach dostępne są podstawowe instrukcje sterujące, takie jak np.
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">for</span> <span class="pre">%}</span></code> czy <code class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code>. Tę pierwszą wykorzystamy do wyświetlenia
komunikatów użytkownikowi, drugą m. in. do sprawdzenia, czy stronę odwiedza
użytkownik uwierzytelniony. Dane przekazane do szablonu możemy wyświetlać
stosując odpowiednią notację, np.: <code class="docutils literal"><span class="pre">{{</span> <span class="pre">user.username</span> <span class="pre">}}</span></code>.
Dodatkowo wyświetlane dane można obrabiać za pomocą filtrów,
np. <code class="docutils literal"><span class="pre">{{</span> <span class="pre">komunikat|capfirst</span> <span class="pre">}}</span></code> – w tym wypadku wszystkie komunikaty
zostaną wyświetlone z wielkiej litery.</p>
<p>W pliku <code class="file docutils literal"><span class="pre">index.html</span></code> umieszczamy również link do strony rejestracji,
który wyświetlany będzie tylko użytkownikom niezalogowanym. Aby wygenerować adres
strony w atrybucie <code class="docutils literal"><span class="pre">href</span></code> używamy funkcji <code class="docutils literal"><span class="pre">url</span></code>, za którą podajemy
w cudzysłowach nazwę nadaną adresowi w pliku <code class="docutils literal"><span class="pre">urls.py</span></code>, np.:
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">url</span> <span class="pre">'rejestruj'</span> <span class="pre">%}</span></code>.</p>
<div class="section" id="cwiczenie-2">
<h3>4.4.6.1. Ćwiczenie 2<a class="headerlink" href="#cwiczenie-2" title="Permalink to this headline">¶</a></h3>
<p>Po ewentualnym ponownym uruchomieniu serwera, zarejestruj nowego użytkownika
o nazwie &#8220;ewa&#8221;. Powinieneś zobaczyć poniższą stronę:</p>
<div class="figure">
<img alt="../../_images/czat13rej.png" src="../../_images/czat13rej.png" />
</div>
<p>W przeglądarce wpisz adres <em>127.0.0.1:8000/rejestruj</em>, aby przejść do strony
rejestracji. Na stronie wyświetla się formularz, mimo że jesteś już zarejestrowany
i zalogowany.</p>
<p>Spróbuj zmienić szablon <code class="docutils literal"><span class="pre">rejestruj.html</span></code>, tak aby zalogowanym
użytkownikom wyświetlał się tekst &#8220;Jesteś już zarejestrowany&#8221; oraz
link do strony głównej, a niezalogowanym formularz rejestracji.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Wykorzystaj tag <code class="docutils literal"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">warunek</span> <span class="pre">%}</span></code> i obiekt <code class="docutils literal"><span class="pre">user</span></code>, tak jak zrobiliśmy to
w widoku <code class="docutils literal"><span class="pre">index()</span></code> i dopisz odpowiedni kod w widoku <code class="docutils literal"><span class="pre">rejestruj()</span></code>.</p>
</div>
<p>Przykładowy efekt poprawnego wykonania ćwiczenia:</p>
<div class="figure">
<img alt="../../_images/czat14rej.png" src="../../_images/czat14rej.png" />
</div>
</div>
</div>
<div class="section" id="logowanie-i-wylogowywanie">
<h2><a class="toc-backref" href="#id19">4.4.7. Logowanie i wylogowywanie</a><a class="headerlink" href="#logowanie-i-wylogowywanie" title="Permalink to this headline">¶</a></h2>
<p>Skoro użytkownicy mogą się rejestrować, trzeba umożliwić im również logowanie
i wylogowywanie z serwisu. Również to zadanie można zrobić dwojako.
Pierwszy sposób to tak jak w przypadku rejestracji stworzenie widoków
w pliku <code class="file docutils literal"><span class="pre">views.py</span></code> i powiązanie ich z adresami w pliku <code class="file docutils literal"><span class="pre">urls.py</span></code>.</p>
<p>Na początku jak zawsze importujemy wymagane funkcje, później dopisujemy
widok <code class="docutils literal"><span class="pre">loguj()</span></code> i <code class="docutils literal"><span class="pre">wyloguj()</span></code> w pliku <code class="file docutils literal"><span class="pre">views.py</span></code>:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loguj</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logowanie użytkownika&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">django.contrib.auth.forms</span> <span class="kn">import</span> <span class="n">AuthenticationForm</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AuthenticationForm</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">get_user</span><span class="p">())</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;Zostałeś zalogowany!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

    <span class="n">kontekst</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">AuthenticationForm</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;czat/loguj.html&#39;</span><span class="p">,</span> <span class="n">kontekst</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">wyloguj</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wylogowanie użytkownika&quot;&quot;&quot;</span>
    <span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&quot;Zostałeś wylogowany!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
<p>Podobnie jak w przypadku rejestrowania użytkowników, korzystamy z wbudowanego w Django
formularza logowania <code class="docutils literal"><span class="pre">AuthenticationForm</span></code>. Dzięki temu nie musimy
&#8220;ręcznie&#8221; sprawdzać poprawności podanych danych, robi to metoda <code class="docutils literal"><span class="pre">is_valid()</span></code>
formularza. Jeżeli nie zwróci ona błędu, możemy zalogować użytkownika za
pomocą funkcji <code class="docutils literal"><span class="pre">login()</span></code>, której przekazujemy obiekty <code class="docutils literal"><span class="pre">HttpRequest</span></code>
(przesłane żadanie) i <code class="docutils literal"><span class="pre">User</span></code> – obiekt użytkownika zwrócony przez metodę
<code class="docutils literal"><span class="pre">get_user()</span></code> formularza.</p>
<p>Wylogowanie polega na użyciu funkcji <code class="docutils literal"><span class="pre">logout(request)</span></code> – wyloguje ona
użytkownika, którego dane zapisane są w przesłanym żądaniu.</p>
<p>Jak widać, do logowania potrzebujemy szablonu. Najprościej utworzyć go
na podstawie szablonu <code class="file docutils literal"><span class="pre">rejestruj.html</span></code>. Otwórzmy go i zapiszmy do
pliku <code class="file docutils literal"><span class="pre">~/czat/czat/templates/czat/loguj.html</span></code>. Później wystarczy
dostosować wywietlany tekst. Szablon z uwzględnieniem zmian wprowadzonych
w ćwiczeniu 2. może wyglądać tak:</p>
<div class="code_no">Plik loguj.html nr <script>var plik_no = plik_no || 1; document.write(plik_no++);</script></div><div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">&lt;!-- czat/czat/templates/czat/loguj.html --&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Logowanie użytkownika<span class="nt">&lt;/h1&gt;</span>
        {% if user.is_authenticated %}
            <span class="nt">&lt;p&gt;</span>Jesteś już zalogowany jako {{ user.username }}.
            <span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>Strona główna<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        {% else %}
        <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
            {% csrf_token %}
            {{ form.as_p }}
            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Zaloguj<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
        {% endif %}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>Pozostaje skojarzenie odpowiednich adresów URL z utworzonymi widokami.
W pliku <code class="file docutils literal"><span class="pre">urls.py</span></code> dopisujemy reguły:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^rejestruj/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">rejestruj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;rejestruj&#39;</span><span class="p">),</span>
<span class="hll">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^loguj/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">loguj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;loguj&#39;</span><span class="p">),</span>
</span><span class="hll">    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^wyloguj/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">wyloguj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;wyloguj&#39;</span><span class="p">),</span>
</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Możesz przetestować działanie dodanych funkcji wywołując w przeglądarce adresy:
<code class="docutils literal"><span class="pre">127.0.0.1:8000/loguj</span></code> i <code class="docutils literal"><span class="pre">127.0.0.1:8000/wyloguj</span></code>. Przykładowy formularz
wygląda tak:</p>
<div class="figure">
<img alt="../../_images/czat15log.png" src="../../_images/czat15log.png" />
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Podsumujmy</strong>: działanie wszystkich omówionych do tej pory widoków jest podobne.
Po przejściu pod adres określony w pliku <code class="file docutils literal"><span class="pre">urls.py</span></code>, np. <em>127.0.0.1:8000/loguj/</em>,
wywoływany jest powiązany z nim widok zdefiniowany w pliku <code class="file docutils literal"><span class="pre">views.py</span></code>,
np. <code class="docutils literal"><span class="pre">loguj()</span></code>. Tego typu operacja generuje żądanie typu <a class="reference internal" href="../todo/index.html#term-get"><span class="xref std std-term">GET</span></a>,
w odpowiedzi na które zwracany jest szablon (np. <code class="file docutils literal"><span class="pre">loguj.html</span></code>)
wyświetlający przekazny do niego formularz (np. <code class="docutils literal"><span class="pre">AuthenticationForm</span></code>).</p>
<p class="last">Po wypełnieniu formularza użytkownik wciska odpowiedni przycisk, który
inicjuje żądanietypu <a class="reference internal" href="../todo/index.html#term-post"><span class="xref std std-term">POST</span></a>, a więc przesyłanie danych na serwer.
Widoki <code class="docutils literal"><span class="pre">rejestruj()</span></code> i <code class="docutils literal"><span class="pre">loguj()</span></code> wychwytują i przetwarzają takie żądania,
tj. rejestrują lub logują użytkownika. W odpowiedzi użytkownik
zostaje przekierowany z odopiwednim komunikatem na stonę główną.</p>
</div>
<div class="section" id="cwiczenie-3">
<h3>4.4.7.1. Ćwiczenie 3<a class="headerlink" href="#cwiczenie-3" title="Permalink to this headline">¶</a></h3>
<p>Adresów logowania i wylogowywania nikt w serwisach nie wpisuje ręcznie.
Wstaw zatem odpowiednie linki do szablonu strony głównej. Użytkownik
niezalogowany powinien zobaczyć odnośnik <em>Zaloguj</em>, użytkownik
zalogowany – <em>Wyloguj</em>. Przykładowe strony mogą wyglądać tak:</p>
<div class="figure">
<img alt="../../_images/czat16log.png" src="../../_images/czat16log.png" />
</div>
<div class="figure">
<img alt="../../_images/czat17log.png" src="../../_images/czat17log.png" />
</div>
</div>
</div>
<div class="section" id="obsluga-wiadomosci">
<h2><a class="toc-backref" href="#id20">4.4.8. Obsługa wiadomości</a><a class="headerlink" href="#obsluga-wiadomosci" title="Permalink to this headline">¶</a></h2>
<p>Chcemy, by zalogowani użytkownicy mogli przeglądać wiadomości wszystkich użytkowników,
zmieniać, usuwać i dodawać własne.</p>
<p>Potrzebować będziemy widoku o nazwie np. <code class="docutils literal"><span class="pre">wiadomosci()</span></code> do wyświetlania
(żądania GET) i dodawania wiadomości (żądania POST), który zwracał będzie
szablon np. <code class="file docutils literal"><span class="pre">wiadomosci.html</span></code>. Widok ten powiążemy z adresem <em>/wiadomosci</em>.
Do pliku <code class="file docutils literal"><span class="pre">views.py</span></code> dodajemy importy i kod funkcji:</p>
<div class="code_no">Kod nr <script>var code_no = code_no || 1; document.write(code_no++);</script></div><div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">czat.models</span> <span class="kn">import</span> <span class="n">Wiadomosc</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>

<span class="nd">@login_required</span><span class="p">(</span><span class="n">login_url</span><span class="o">=</span><span class="s">&#39;/loguj&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">wiadomosci</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dodawanie i wyświetlanie wiadomości&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">tekst</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tekst&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tekst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">250</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
            <span class="s">&quot;Wiadomość nie może być pusta, może mieć maks. 250 znaków!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wiadomosc</span> <span class="o">=</span> <span class="n">Wiadomosc</span><span class="p">(</span><span class="n">tekst</span><span class="o">=</span><span class="n">tekst</span><span class="p">,</span>
                        <span class="n">data_pub</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                        <span class="n">autor</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">wiadomosc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">&#39;wiadomosci&#39;</span><span class="p">))</span>

    <span class="n">wiadomosci</span> <span class="o">=</span> <span class="n">Wiadomosc</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">kontekst</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;user&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s">&#39;wiadomosci&#39;</span><span class="p">:</span> <span class="n">wiadomosci</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;czat/wiadomosci.html&#39;</span><span class="p">,</span> <span class="n">kontekst</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Widać powyżej, że treść przesłanej wiadomości wydobywamy ze słownika
<code class="docutils literal"><span class="pre">request.POST</span></code> za pomocą metody <code class="docutils literal"><span class="pre">get('tekst',</span> <span class="pre">'')</span></code>. Jej pierwszy argument
odpowiada nazwie pola formularza użytej w szablonie, które chcemy odczytać.
Drugi argument oznacza wartość domyślną, przydatną, jeśli
pole będzie niedostępne. Po sprawdzeniu długości wiadomości, możemy
ją utworzyć wykorzystując konstruktor naszego modelu
<code class="docutils literal"><span class="pre">Wiadomosc(tekst=tekst,</span> <span class="pre">data_pub=timezone.now(),</span> <span class="pre">autor=request.user)</span></code>.
W formie nazwanych argumentów podajemy mu wartości kolejnych pól.
Zapisanie nowej wiadomości w bazie sprowadza się do polecenia <code class="docutils literal"><span class="pre">wiadomosc.save()</span></code>.</p>
<p>Na koniec przekierowujemy użytkownika do tego samego widoku,
ale tym razem jest to żądanie typu <a class="reference internal" href="../todo/index.html#term-get"><span class="xref std std-term">GET</span></a>.
W odpowiedzi na nie pobieramy wszystkie wiadomości z bazy (<code class="docutils literal"><span class="pre">Wiadomosc.objects.all()</span></code>),
i przekazujemy do szablonu, który zwracamy użytkownikowi.</p>
<p>Zadaniem szablonu zapisanego w pliku <code class="file docutils literal"><span class="pre">~/czat/czat/templates/wiadomosci.html</span></code>
jest wyświetlenie komunikatów zwrotnych, formularza dodawania wiadomości
i listy wiadomości dodanych.</p>
<div class="code_no">Plik wiadomosci.html nr <script>var plik_no = plik_no || 1; document.write(plik_no++);</script></div><div class="highlight-html"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">&lt;!-- czat/czat/templates/czat/wiadomosci.html --&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Wiadomości<span class="nt">&lt;/h1&gt;</span>

        {% if messages %}
            <span class="nt">&lt;ul&gt;</span>
            {% for komunikat in messages %}
                <span class="nt">&lt;li&gt;</span>{{ komunikat|capfirst }}<span class="nt">&lt;/li&gt;</span>
            {% endfor %}
            <span class="nt">&lt;/ul&gt;</span>
        {% endif %}

        <span class="nt">&lt;h2&gt;</span>Dodaj wiadomość<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
            {% csrf_token %}
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;tekst&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>Zapisz<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/form&gt;</span>

        <span class="nt">&lt;h2&gt;</span>Lista wiadomości:<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;ol&gt;</span>
            {% for wiadomosc in wiadomosci %}
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;strong&gt;</span>{{ wiadomosc.autor.username }}<span class="nt">&lt;/strong&gt;</span> ({{ wiadomosc.data_pub }}):
                <span class="nt">&lt;br</span> <span class="nt">/&gt;</span> {{ wiadomosc.tekst }}
            <span class="nt">&lt;/li&gt;</span>
            {% endfor %}
        <span class="nt">&lt;/ol&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="cwiczenie-4">
<h3>4.4.8.1. Ćwiczenie 4<a class="headerlink" href="#cwiczenie-4" title="Permalink to this headline">¶</a></h3>
<p>Powiąż widok <code class="docutils literal"><span class="pre">wiadomosci()</span></code> z adresem <em>/wiadomosci</em> w pliku <code class="file docutils literal"><span class="pre">urls.py</span></code>,
nadając mu nazwę <em>wiadomosci</em>, a następnie uzupełnij szablon widoku głównego,
aby zalogowanym użytkownikom wyświetlał się link prowadzący do strony z wiadomościami.
W szablonie <code class="docutils literal"><span class="pre">wiadomosci.html</span></code> dodaj link do strony głównej i link wylogowania.</p>
<p>Zaloguj się i przetestuj wyświetlanie <a class="footnote-reference" href="#id12" id="id11">[6]</a> i dodawanie wiadomości pod adresem
<em>127.0.0.1:8000/wiadomosci/</em>. Sprawdź, co się stanie po wysłaniu pustej
wiadomości.</p>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id11">[6]</a></td><td>Jeżeli nie dodałeś do tej pory żadnej wiadomości, lista na początku
będzie pusta.</td></tr>
</tbody>
</table>
<p>Poniższe zrzuty prezentują efekty naszej pracy:</p>
<div class="figure">
<img alt="../../_images/czat21wiadomosci.png" src="../../_images/czat21wiadomosci.png" />
</div>
</div>
</div>
<div class="section" id="materialy">
<h2><a class="toc-backref" href="#id21">4.4.9. Materiały</a><a class="headerlink" href="#materialy" title="Permalink to this headline">¶</a></h2>
<div class="section" id="slownik">
<h3>4.4.9.1. Słownik<a class="headerlink" href="#slownik" title="Permalink to this headline">¶</a></h3>
<dl class="glossary docutils">
<dt id="term-aplikacja">aplikacja</dt>
<dd>program komputerowy.</dd>
<dt id="term-framework">framework</dt>
<dd>zestaw komponentów i bibliotek wykorzystywany do budowy aplikacji,
przykładem jest biblioteka Pythona Flask.</dd>
<dt id="term-html">HTML</dt>
<dd>język znaczników wykorzystywany do formatowania dokumentów, zwłaszcza stron WWW.</dd>
<dt id="term-css">CSS</dt>
<dd>język służący do opisu formy prezentacji stron WWW.</dd>
<dt id="term-http">HTTP</dt>
<dd>protokół przesyłania dokumentów WWW.</dd>
<dt id="term-get">GET</dt>
<dd>typ żądania HTTP, służący do pobierania zasobów z serwera WWW.</dd>
<dt id="term-post">POST</dt>
<dd>typ żądania HTTP, służący do umieszczania zasobów na serwerze WWW.</dd>
<dt id="term-logowanie">logowanie</dt>
<dd>proces autoryzacji i uwierzytelniania użytkownika w systemie.</dd>
<dt id="term-orm">ORM</dt>
<dd>mapowanie obiektowo-relacyjne, oprogramowanie służące do przekształcania struktur bazy danych na obiekty klasy danego języka oprogramowania.</dd>
<dt id="term-serwer-deweloperski-testowy">serwer deweloperski (testowy)</dt>
<dd>serwer www używany w czasie prac nad oprogramowaniem.</dd>
<dt id="term-serwer-www">serwer WWW</dt>
<dd>serwer obsługujący protokół HTTP.</dd>
<dt id="term-baza-danych">baza danych</dt>
<dd>program przeznaczony do przechowywania i przetwarzania danych.</dd>
<dt id="term-szablon">szablon</dt>
<dd>wzorzec (nazywany czasem templatką) strony WWW wykorzystywany do renderowania widoków.</dd>
<dt id="term-url">URL</dt>
<dd>ustandaryzowany format adresowania zasobów w internecie (<a class="reference external" href="http://pl.wikipedia.org/wiki/Uniform_Resource_Locator">przykład</a>).</dd>
<dt id="term-model">model</dt>
<dd>schematy i źródła danych aplikacji.</dd>
<dt id="term-widok">widok</dt>
<dd>we Flasku lub Django jest to funkcja, która obsługuje żądania wysyłane przez użytkownika
i na ich podstawie przygotowuje dane zwracane do przeglądarki, najczęściej  w formie strony WWW.</dd>
<dt id="term-kontroler">kontroler</dt>
<dd>logika aplikacji, w Django zawarta w funkcji obsługującej widok.</dd>
</dl>
<ol class="arabic simple">
<li>O Django <a class="reference external" href="http://pl.wikipedia.org/wiki/Django_(informatyka">http://pl.wikipedia.org/wiki/Django_(informatyka</a>)</li>
<li>Strona projektu Django <a class="reference external" href="https://www.djangoproject.com/">https://www.djangoproject.com/</a></li>
<li>Co to jest framework? <a class="reference external" href="http://pl.wikipedia.org/wiki/Framework">http://pl.wikipedia.org/wiki/Framework</a></li>
<li>Co nieco o HTTP i żądaniach GET i POST <a class="reference external" href="http://pl.wikipedia.org/wiki/Http">http://pl.wikipedia.org/wiki/Http</a></li>
</ol>
</div>
<div class="section" id="zrodla">
<h3>4.4.9.2. Źródła<a class="headerlink" href="#zrodla" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference download internal" href="../../_downloads/czat_pp.zip"><code class="xref download docutils literal"><span class="pre">czat_pp.zip</span></code></a></li>
</ul>
</div>
<div class="section" id="metryka">
<h3>4.4.9.3. Metryka<a class="headerlink" href="#metryka" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Autorzy:</th><td class="field-body">Robert Bednarz</td>
</tr>
<tr class="field-even field"><th class="field-name">Utworzony:</th><td class="field-body">2015-04-23 o 22:49</td>
</tr>
</tbody>
</table>
<style>
    div.code_no { text-align: right; background: #e3e3e3; padding: 6px 12px; }
    div.highlight, div.highlight-python { margin-top: 0px; }
</style><p>
    <a style="float:left; margin: 0.3em 1em 1em 0" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
        <img alt="Licencja Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
    Materiały <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Python 101</span>
    udostępniane przez <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.ceo.org.pl/" property="cc:attributionName" rel="cc:attributionURL">
    Centrum Edukacji Obywatelskiej</a> na licencji <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
    Creative Commons Uznanie autorstwa-Na tych samych warunkach 4.0 Międzynarodowa</a>.<br />
</p>

<script>
  // dla http://koduj-z-klasa.github.io/python101/
  // w read the docs kod uzupełnia się w dashboardzie
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55172998-1', 'auto');
  ga('send', 'pageview');
</script></div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../faq/index.html" class="btn btn-neutral float-right" title="FAQ">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../quiz_orm/index.html" class="btn btn-neutral" title="4.3. Quiz ORM"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="../../copyright.html">Copyright</a> 2014, Centrum Edukacji Obywatelskiej.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/custom.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>